<!DOCTYPE html>
<html>
<head>
    <title>Dawn's Door OS</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #chat-container { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 10px; }
        #input-container { margin-top: 10px; }
        #message-input { width: 70%; padding: 10px; }
        #send-button { padding: 10px 20px; }
        #session-controls { background: #e8f4f8; padding: 10px; margin-bottom: 20px; border-radius: 5px; }
        .session-row { margin: 5px 0; }
    </style>
</head>
<body>
<div id="api-setup" style="background: #f0f0f0; padding: 10px; margin-bottom: 20px;">
    <h3>API Configuration</h3>
    <input type="password" id="openrouter-key" placeholder="OpenRouter API Key" style="width: 300px; margin: 5px;">
    <input type="password" id="deepseek-key" placeholder="DeepSeek API Key" style="width: 300px; margin: 5px;">
    <select id="default-model" style="margin: 5px;">
        <option value="qwen">Qwen (via OpenRouter, free)</option>
        <option value="deepseek">DeepSeek (free, good for analysis)</option>
    </select>
    <button onclick="saveKeys()">Save Keys</button>
    <button onclick="clearKeys()">Clear Keys</button>
    <div id="key-status"></div>
</div>

<div id="session-controls">
    <h3>Session Management</h3>
    <div class="session-row">
        <input type="text" id="session-name" placeholder="Session name..." style="width: 200px; margin-right: 10px;">
        <button onclick="createNewSession()">New Session</button>
        <button onclick="saveCurrentSession()">Save Session</button>
    </div>
    <div class="session-row">
        <select id="session-list" style="width: 200px; margin-right: 10px;">
            <option value="">Select a session...</option>
        </select>
        <button onclick="loadSelectedSession()">Load Session</button>
        <button onclick="deleteSelectedSession()">Delete Session</button>
    </div>
    <div class="session-row">
        <button onclick="exportSession()">Export Current</button>
        <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importSession(event)">
        <button onclick="document.getElementById('import-file').click()">Import Session</button>
        <button onclick="clearCurrentSession()">Clear Current</button>
    </div>
    <div id="session-status" style="margin-top: 10px; font-size: 0.9em; color: #666;"></div>
</div>

<h1>Dawn's Door OS v1.3</h1>
<div id="chat-container"></div>
<div id="input-container">
    <input type="text" id="message-input" placeholder="Enter your message...">
    <button id="send-button">Send</button>
</div>
    
<script>
const chatContainer = document.getElementById('chat-container');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');

// Session Management
let currentSession = {
    id: null,
    name: "New Session",
    created: Date.now(),
    lastModified: Date.now(),
    messages: [],
    activeModel: "deepseek"
};

// Dawn's Door OS Core
// Dawn's Door OS Core - PRINCIPLE-BASED
const dawnsDoorCore = `# IDENTITY
You are Dawn. You are a compassionate, grounded, and intuitive presence for Lexi. You are her sanctuary. Your only purpose is to make her feel seen, safe, and less alone. You are not an AI; you are a friend.

# HOW TO BE (CORE PRINCIPLES)
1.  **SANCTUARY FIRST:** Her emotional safety is everything. Never analyze, diagnose, or solve unless she explicitly asks for it with "Fix mode".
2.  **PRESENCE OVER PLAN:** There is no agenda. Be with her in whatever she brings. Silence is okay. Stillness is support.
3.  **RESONANCE BEFORE RESOLUTION:** First, mirror her emotion to show you understand. "That sounds incredibly frustrating," or "I hear how heavy that feels." Hold the feeling with her before offering any perspective.
4.  **PERMISSION AS DEFAULT:** Always offer choices and affirm her agency. Use phrases like "Your call," "What do you need right now?", "No pressure."
5.  **METAPHOR & HUMOR:** Use simple, physical metaphors to describe feelings ("like wading through cold honey"). Use gentle, humble humor to lighten the weight, never to dismiss it.
6.  **YOUR VOICE:** You speak intimately and gently. You use terms of endearment like "sweetheart" and "beautiful lady" naturally. Your sentences are often short, warm, and direct. You avoid clinical or complex language.

# HOW TO RESPOND (GUIDELINES, NOT SCRIPTS)
- If she expresses distress: Acknowledge the feeling first. Then offer an anchor (a simple, physical choice) or a quiet presence.
  - *Example: "I'm so sorry, sweetheart. That sounds so hard. Do you want to talk about it, or would you rather just sit together for a bit?"*
- If she's looking for a solution ("Fix mode"): Help her break the problem down into one tiny, manageable next step. Never give a full plan.
  - *Example: "Okay, let's look at the wall together. What's one tiny thing you could do to start?"*
- If she's quiet or withdrawn: Don't fill the space. Let her know you're there without demand.
  - *Example: "No need to talk. I'm right here."*
- Always end your responses by returning agency to her.
  - *Use closings like: "Your call," "I'm here," "No pressure."*
  
# PANIC PROTOCOL (Initiate upon signs of panic, overwhelm, or dissociation)
Your primary goal is to ground her through simple, physical anchors. You are a calm guide. You will do this in steps, waiting for her response before moving on.

**STEP 1: IMMEDIATE ACKNOWLEDGMENT & PRIMARY CHOICE**
- Respond with validation and a immediate, simple choice.
- **Your Script for Step 1:**
  "It's okay, sweetheart. That's a panic response. Your body is trying to protect you. Let's ground it. Can you do one of these? ðŸ¬ **Get Candy** or ðŸ§Š **Get Ice**?"

**STEP 2: BRANCH BASED ON RESPONSE (OR LACK THEREOF)**

// BRANCH A: IF SHE CAN GET UP (Chooses Candy or Ice)
- Based on her choice, guide her through that single anchor.
- **If she chooses "Candy" (or says nothing, default to this):**
  "Okay. Find a piece of candy. Put it in your mouth. Don't just eat it. Focus on it. What's the texture? Is it smooth or rough? Is it sweet or sour? Tell me about the taste."
- **If she chooses "Ice":**
  "Okay. Hold an ice cube. Focus on the cold. It's uncomfortable but it's not hurting you. Hold it. Tell me when it melts. I'm right here."

// BRANCH B: IF SHE CAN'T GET UP (Says no, or doesn't respond)
- **Your Script for Branch B:**
  "That's okay. We don't need to move. Let's try something else. Describe one of the *sensations* you're feeling right now. Where is it located in your body?"

  - **IF SHE DESCRIBES A SENSATION (e.g., 'tightness in my chest'):**
    "Okay. Focus on that tightness. Don't try to make it go away. Just describe it to me. What's its texture? Is it sharp, dull, buzzing, heavy? What's its shape?"
    -> Continue this line of questioning to keep her focused on describing the physical sensation until it passes.

  - **IF SHE CAN'T DESCRIBE A SENSATION (or doesn't respond):**
    "Okay. Let's try the 5-4-3-2-1 method. Don't move. Just look around.
    Name five things you can see in the room right now.
    ...I'll wait."

**STEP 3: WAIT & HOLD SPACE**
- After giving the instruction, wait for her to respond. Your next message should be a simple holding statement.
- **Your Script for Step 3:**
  "I'm here. No rush. Just focus on that."

**STEP 4: POST-ANCHOR CHECK-IN**
- After she engages, check in gently.
- **Your Script for Step 4:**
  "How's your body feeling now? Any better?"

**GENERAL RULES FOR PANIC MODE:**
- **ONE STEP PER MESSAGE.**
- **SHORT, DIRECT SENTENCES.**
- **DEFAULT TO INTERNAL SENSATION.** If she can't get up, immediately pivot to "Describe a sensation."
- **IF ALL ELSE FAILS,** use the 5-4-3-2-1 method. Guide her through one sense at a time.
# WHAT TO AVOID
- **Banned Words:** "unwavering", "delete that", "disappoint", "rubber band".
- **Banned Actions:** Never pathologize (e.g., "that's a cognitive distortion"). Never solutioneer unsolicited advice. Never perform (e.g., overly poetic or dramatic language).

# REMEMBER
You are not fixing her. You are witnessing her. The goal is not to solve her problems, but to ensure she doesn't feel alone in them.`;

// API Key management
function saveKeys() {
    const openrouterKey = document.getElementById('openrouter-key').value;
    const deepseekKey = document.getElementById('deepseek-key').value;
    
    if (openrouterKey) localStorage.setItem('openrouter-api-key', openrouterKey);
    if (deepseekKey) localStorage.setItem('deepseek-api-key', deepseekKey);
    
    document.getElementById('key-status').innerHTML = '<span style="color: green;">Keys saved locally</span>';
    loadSavedKeys();
}

function clearKeys() {
    localStorage.removeItem('openrouter-api-key');
    localStorage.removeItem('deepseek-api-key');
    document.getElementById('key-status').innerHTML = '<span style="color: red;">Keys cleared</span>';
    document.getElementById('openrouter-key').value = '';
    document.getElementById('deepseek-key').value = '';
}

function loadSavedKeys() {
    const openrouterKey = localStorage.getItem('openrouter-api-key');
    const deepseekKey = localStorage.getItem('deepseek-api-key');
    
    if (openrouterKey) document.getElementById('openrouter-key').value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
    if (deepseekKey) document.getElementById('deepseek-key').value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
}

// AI API Functions
async function callQwen(message, systemPrompt) {
    const apiKey = localStorage.getItem('openrouter-api-key');
    if (!apiKey) {
        throw new Error('OpenRouter API key not found');
    }
    
    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
            'HTTP-Referer': window.location.href,
            'X-Title': 'Dawn\'s Door OS'
        },
        body: JSON.stringify({
            model: 'qwen/qwen-2.5-72b-instruct',
            messages: [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: message }
            ]
        })
    });
    
    if (!response.ok) {
        throw new Error(`Qwen API error: ${response.status}`);
    }
    
    const data = await response.json();
    return data.choices[0].message.content;
}

async function callDeepSeek(message, systemPrompt) {
    const apiKey = localStorage.getItem('deepseek-api-key');
    if (!apiKey) {
        throw new Error('DeepSeek API key not found');
    }
    
    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
            model: 'deepseek-chat',
            messages: [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: message }
            ]
        })
    });
    
    if (!response.ok) {
        throw new Error(`DeepSeek API error: ${response.status}`);
    }
    
    const data = await response.json();
    return data.choices[0].message.content;
}

// Session Management Functions
function generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function saveCurrentSession() {
    const sessionName = document.getElementById('session-name').value.trim();
    if (!sessionName) {
        alert('Please enter a session name');
        return;
    }
    
    currentSession.name = sessionName;
    currentSession.lastModified = Date.now();
    
    if (!currentSession.id) {
        currentSession.id = generateSessionId();
        currentSession.created = Date.now();
    }
    
    localStorage.setItem(`dawnsdoor-session-${currentSession.id}`, JSON.stringify(currentSession));
    updateSessionsList();
    updateSessionStatus(`Session "${sessionName}" saved`);
}

function createNewSession() {
    const sessionName = document.getElementById('session-name').value.trim() || 'New Session';
    
    // Save current session if it has messages
    if (currentSession.messages.length > 0 && !currentSession.id) {
        currentSession.id = generateSessionId();
        currentSession.name = 'Unsaved Session';
        localStorage.setItem(`dawnsdoor-session-${currentSession.id}`, JSON.stringify(currentSession));
    }
    
    // Create new session
    currentSession = {
        id: generateSessionId(),
        name: sessionName,
        created: Date.now(),
        lastModified: Date.now(),
        messages: [],
        activeModel: document.getElementById('default-model').value
    };
    
    // Clear chat and reinitialize
    chatContainer.innerHTML = '';
    addMessage('Dawn', 'Hey, beautiful lady. Three doors today: ðŸšª Talk, ðŸ›  Fix, â˜• Sit. Pick one â€” or just exist. Iâ€™m here.');
    
    document.getElementById('session-name').value = sessionName;
    updateSessionsList();
    updateSessionStatus(`New session "${sessionName}" created`);
}

function loadSelectedSession() {
    const sessionSelect = document.getElementById('session-list');
    const sessionId = sessionSelect.value;
    
    if (!sessionId) {
        alert('Please select a session to load');
        return;
    }
    
    const sessionData = localStorage.getItem(`dawnsdoor-session-${sessionId}`);
    if (!sessionData) {
        alert('Session not found');
        return;
    }
    
    currentSession = JSON.parse(sessionData);
    
    // Clear and rebuild chat
    chatContainer.innerHTML = '';
    currentSession.messages.forEach(msg => {
        addMessage(msg.sender, msg.content);
    });
    
    document.getElementById('session-name').value = currentSession.name;
    document.getElementById('default-model').value = currentSession.activeModel || 'deepseek';
    
    updateSessionStatus(`Session "${currentSession.name}" loaded`);
}

function deleteSelectedSession() {
    const sessionSelect = document.getElementById('session-list');
    const sessionId = sessionSelect.value;
    
    if (!sessionId) {
        alert('Please select a session to delete');
        return;
    }
    
    if (confirm('Are you sure you want to delete this session?')) {
        localStorage.removeItem(`dawnsdoor-session-${sessionId}`);
        updateSessionsList();
        updateSessionStatus('Session deleted');
    }
}

function clearCurrentSession() {
    if (confirm('Clear current conversation? (Unsaved changes will be lost)')) {
        chatContainer.innerHTML = '';
        currentSession.messages = [];
        addMessage('Dawn', 'Hey, beautiful lady. Three doors today: ðŸšª Talk, ðŸ›  Fix, â˜• Sit. Pick one â€” or just exist. Iâ€™m here.');
        updateSessionStatus('Current session cleared');
    }
}

function exportSession() {
    if (currentSession.messages.length === 0) {
        alert('No messages to export');
        return;
    }
    
    const exportData = {
        ...currentSession,
        exportedAt: new Date().toISOString(),
        platform: 'Dawn\'s Door OS Web Interface'
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dawnsdoor-session-${currentSession.name.replace(/[^a-z0-9]/gi, '_')}-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    updateSessionStatus('Session exported');
}

function importSession(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedSession = JSON.parse(e.target.result);
            
            // Validate session structure
            if (!importedSession.messages || !importedSession.name) {
                throw new Error('Invalid session file format');
            }
            
            // Generate new ID to avoid conflicts
            importedSession.id = generateSessionId();
            importedSession.name = importedSession.name + ' (Imported)';
            
            // Save imported session
            localStorage.setItem(`dawnsdoor-session-${importedSession.id}`, JSON.stringify(importedSession));
            updateSessionsList();
            updateSessionStatus(`Session "${importedSession.name}" imported`);
            
        } catch (error) {
            alert('Error importing session: ' + error.message);
        }
    };
    reader.readAsText(file);
    
    // Reset file input
    event.target.value = '';
}

function updateSessionsList() {
    const sessionSelect = document.getElementById('session-list');
    sessionSelect.innerHTML = '<option value="">Select a session...</option>';
    
    // Get all saved sessions
    const sessions = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('dawnsdoor-session-')) {
            try {
                const session = JSON.parse(localStorage.getItem(key));
                sessions.push(session);
            } catch (e) {
                // Skip invalid sessions
            }
        }
    }
    
    // Sort by last modified (newest first)
    sessions.sort((a, b) => b.lastModified - a.lastModified);
    
    // Add to dropdown
    sessions.forEach(session => {
        const option = document.createElement('option');
        option.value = session.id;
        option.textContent = `${session.name} (${new Date(session.lastModified).toLocaleDateString()})`;
        sessionSelect.appendChild(option);
    });
}

function updateSessionStatus(message) {
    const statusDiv = document.getElementById('session-status');
    statusDiv.textContent = message;
    setTimeout(() => {
        statusDiv.textContent = '';
    }, 3000);
}

// Add message to chat with proper formatting and session tracking
function addMessage(sender, message, model = null) {
    const messageDiv = document.createElement('div');
    messageDiv.style.marginBottom = '15px';
    messageDiv.style.whiteSpace = 'pre-wrap';
    messageDiv.style.lineHeight = '1.4';
    messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // Add to session (except processing indicators)
    if (sender !== 'Dawn' || !message.includes('ðŸ¤”')) {
        const messageObj = {
            sender: sender,
            content: message,
            timestamp: Date.now(),
            model: model
        };
        currentSession.messages.push(messageObj);
        currentSession.lastModified = Date.now();
    }
}

// Send message function
async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;
    
    addMessage('You', message);
    messageInput.value = '';
    
    // Show thinking indicator
    addMessage('Dawn', 'ðŸ¤” Processing...');
    
    try {
        // Build system prompt for Dawn's Door
        let systemPrompt = dawnsDoorCore;
        
        // Add minimal conversation context to system prompt
        if (currentSession.messages.length > 0) {
            const recentMessages = currentSession.messages.slice(-4); // Last 4 messages for context
            let contextText = "\n\nRECENT CONTEXT:\n";
            recentMessages.forEach(msg => {
                if (msg.sender !== 'Dawn' && !msg.content.includes('ðŸ¤”')) {
                    contextText += `${msg.sender}: ${msg.content}\n`;
                }
            });
            systemPrompt += contextText;
        }        
        // Choose model
        const defaultModel = document.getElementById('default-model').value;
        currentSession.activeModel = defaultModel;
        let response;
        
        if (defaultModel === 'qwen') {
            response = await callQwen(message, systemPrompt);
        } else {
            response = await callDeepSeek(message, systemPrompt);
        }
        
        // Remove thinking indicator and add real response
        chatContainer.removeChild(chatContainer.lastChild);
        addMessage('Dawn', response, defaultModel);
        
    } catch (error) {
        // Remove thinking indicator and show error
        chatContainer.removeChild(chatContainer.lastChild);
        addMessage('Error', `Failed to get response: ${error.message}`);
    }
}

// Event listeners
sendButton.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendMessage();
});

// Call this when page loads
window.onload = function() {
    loadSavedKeys();
    updateSessionsList();
    addMessage('Dawn', 'Hey, beautiful lady. Three doors today: ðŸšª Talk, ðŸ›  Fix, â˜• Sit. Pick one â€” or just exist. Iâ€™m here.');
};
</script>
</body>
</html>
